import matplotlib.pyplot as plt
import numpy as np
import os

def get_data(dataset="CINIC10L", updata_mode="both", attack_features=31,):
    if dataset =="CINIC10L":
        if updata_mode=="both":
            if attack_features == 31:
                main_task_acc = [72.62, 72.49, 72.43, 71.95, 69.65, 66.83, 64.13, 61.30, 58.77, 56.56, 53.32, 50.21, 47.88, 43.20, 38.91, 36.04, 31.24, 27.78, 24.54, 23.32, 21.86, 20.53, 19.47, 19.06, 16.71, 14.52, 13.00, 11.96, 11.58, 10.68, 9.52]
                asr = [99.98, 99.97, 99.97, 99.97, 99.96, 99.95, 99.91, 99.87, 99.75, 99.47, 98.52, 97.86, 97.30, 96.95, 92.13, 80.27, 68.78, 32.59, 0.79, 0.27, 0.30, 0.69, 2.13, 6.90, 26.95, 50.15, 60.16, 67.25, 69.14, 72.25, 68.98]
            elif attack_features == 28:
                main_task_acc = [71.50, 71.84, 71.75, 71.54, 71.44, 71.10, 70.13, 69.04, 67.73, 66.98, 65.42, 64.01, 62.95, 61.48, 60.00, 58.25, 57.27, 55.79, 54.81, 53.96, 51.55, 49.28, 47.05, 44.92, 42.72, 40.64, 38.39, 36.81, 34.75, 33.14, 31.95]
                asr = [99.78, 99.57, 99.43, 99.37, 99.34, 99.20, 99.17, 98.88, 98.34, 98.07, 97.77, 97.22, 96.44, 96.69, 94.34, 92.68, 92.81, 91.81, 89.09, 86.80, 78.11, 67.95, 43.47, 33.69, 17.75, 10.51, 4.78, 2.40, 0.31, 0.10, 0.02]
            elif attack_features == 24:
                main_task_acc = [ 71.28, 71.28, 71.19, 70.98, 70.23, 68.08, 65.52, 63.16, 60.93, 58.90, 56.13, 53.97, 53.20, 50.70, 48.24, 45.86, 42.90, 40.46, 37.90, 35.95, 33.38, 31.22, 29.33, 27.29, 26.43, 24.51, 24.10, 22.46, 22.14, 21.24, 20.73]
                asr = [99.89, 99.89, 99.87, 99.88, 99.83, 99.80, 99.73, 99.42, 99.08, 98.46, 97.17, 95.93, 95.25, 91.90, 91.82, 90.04, 87.25, 86.72, 84.96, 82.99, 81.38, 79.00, 76.39, 72.86, 71.60, 68.06, 67.74, 62.48, 58.76, 57.34, 52.87]
            elif attack_features == 20:
                main_task_acc = [67.41, 68.60, 68.35, 68.01, 67.39, 66.42, 64.76, 62.01, 57.89, 53.02, 48.90, 45.17, 42.56, 39.80, 37.27, 35.35, 33.50, 32.39, 30.26, 29.46, 26.20, 24.73, 23.72, 21.94, 21.33, 19.77, 18.29, 17.21, 17.05, 16.29, 15.71]
                asr = [94.83, 91.51, 91.02, 90.18, 89.43, 87.42, 84.52, 78.48, 68.88, 60.37, 54.16, 46.43, 48.41, 44.26, 39.70, 43.00, 37.58, 34.90, 33.38, 31.44, 29.26, 25.70, 22.34, 21.72, 21.04, 16.52, 13.04, 9.13, 9.21, 7.57, 5.34]
            elif attack_features == 16:
                main_task_acc = [64.36, 67.11, 66.39, 65.51, 64.00, 61.97, 59.27, 56.48, 53.35, 50.78, 48.49, 46.14, 44.45, 42.74, 39.89, 34.79, 30.09, 26.17, 23.79, 21.57, 19.65, 16.51, 13.98, 12.00, 10.72, 9.89, 9.65, 9.11, 8.14, 7.54, 6.61]
                asr = [85.48, 88.43, 87.87, 87.76, 87.77, 83.63, 78.58, 71.16, 62.99, 54.93, 49.68, 46.14, 43.27, 43.01, 46.64, 43.07, 44.02, 38.57, 34.99, 35.05, 30.55, 25.30, 24.53, 22.96, 23.40, 19.20, 19.52, 17.09, 15.35, 15.61, 14.16]
            elif attack_features == 8:
                main_task_acc = [70.07, 70.04, 69.85, 69.51, 68.98, 66.40, 62.86, 58.53, 53.51, 49.36, 45.26, 42.32, 39.32, 35.41, 32.34, 31.00, 28.94, 27.71, 26.76, 26.70, 25.38, 24.28, 22.50, 20.74, 17.64, 14.88, 12.82, 11.24, 9.56, 8.69, 7.42]
                asr = [77.64, 81.07, 86.44, 88.89, 91.71, 93.85, 93.57, 93.31, 92.67, 89.46, 83.13, 71.31, 61.03, 58.02, 60.01, 61.88, 61.11, 60.30, 58.53, 60.15, 57.87, 57.81, 57.84, 58.98, 56.96, 54.70, 56.06, 53.18, 52.99, 48.98, 43.16]
            else:
                raise ValueError
        elif updata_mode == "bottom_only":
            if attack_features == 31:
                main_task_acc = [72.62, 72.52, 72.62, 72.60, 72.62, 72.63, 72.55, 72.61, 72.66, 72.60, 72.57, 72.55, 72.70, 72.54, 72.58, 72.55, 72.69, 72.60, 72.62, 72.56, 72.61, 72.68, 72.65, 72.61, 72.53, 72.55, 72.57, 72.63, 72.66, 72.58, 72.63]
                asr = [99.98, 99.97, 99.97, 99.98, 99.98, 99.98, 99.98, 99.97, 99.98, 99.98, 99.98, 99.98, 99.97, 99.98, 99.97, 99.97, 99.98, 99.97, 99.97, 99.98, 99.97, 99.98, 99.98, 99.98, 99.98, 99.97, 99.98, 99.98, 99.97, 99.98, 99.98]
            elif attack_features == 28:
                main_task_acc = [71.50, 71.90, 71.95, 71.92, 71.87, 71.97, 71.93, 71.89, 71.88, 71.86, 71.95, 71.83, 71.97, 71.79, 71.87, 71.95, 71.90, 71.96, 71.86, 71.98, 71.89, 71.90, 71.97, 71.82, 71.87, 71.94, 71.99, 71.89, 71.90, 72.01, 71.84]
                asr = [99.78, 99.56, 99.63, 99.57, 99.64, 99.57, 99.58, 99.56, 99.60, 99.68, 99.66, 99.58, 99.66, 99.49, 99.67, 99.66, 99.56, 99.62, 99.54, 99.65, 99.66, 99.62, 99.67, 99.54, 99.63, 99.62, 99.66, 99.41, 99.62, 99.59, 99.66]
            elif attack_features == 24:
                main_task_acc = [71.28, 71.27, 71.29, 71.32, 71.28, 71.23, 71.32, 71.25, 71.23, 71.17, 71.18, 71.15, 71.08, 71.05, 71.04, 70.97, 70.93, 70.84, 70.87, 70.78, 70.73, 70.62, 70.53, 70.47, 70.43, 70.31, 70.38, 70.23, 70.11, 70.08, 69.84]
                asr = [99.89, 99.90, 99.89, 99.90, 99.89, 99.89, 99.90, 99.89, 99.90, 99.88, 99.89, 99.88, 99.89, 99.87, 99.89, 99.89, 99.88, 99.87, 99.88, 99.90, 99.88, 99.89, 99.90, 99.89, 99.88, 99.89, 99.89, 99.90, 99.90, 99.90, 99.90]
            elif attack_features == 20:
                main_task_acc = [67.41, 68.79, 68.64, 68.56, 68.46, 68.44, 68.39, 68.30, 68.09, 68.18, 68.00, 67.76, 67.69, 67.56, 67.06, 66.95, 66.69, 66.34, 65.93, 65.54, 65.18, 64.83, 64.43, 64.08, 63.60, 62.99, 62.55, 62.41, 62.10, 61.69, 61.56]
                asr = [94.83, 92.12, 91.46, 92.55, 92.23, 93.89, 92.15, 92.81, 91.08, 92.66, 92.60, 92.80, 94.15, 93.32, 92.16, 94.07, 93.67, 94.58, 94.51, 95.56, 94.59, 95.07, 95.21, 96.65, 96.95, 96.96, 96.73, 96.78, 97.10, 97.01, 97.34]
            elif attack_features == 16:
                main_task_acc = [64.36, 67.52, 67.31, 67.10, 67.13, 67.00, 66.75, 66.49, 66.22, 65.83, 65.39, 64.97, 64.40, 63.80, 63.04, 62.37, 61.36, 60.51, 59.15, 57.94, 56.38, 55.08, 53.87, 52.03, 50.84, 49.27, 48.01, 46.53, 45.46, 43.96, 42.87]
                asr = [85.48, 88.21, 88.31, 89.04, 89.65, 90.08, 89.58, 89.25, 90.85, 90.45, 91.01, 90.27, 89.83, 91.66, 92.40, 91.61, 93.36, 93.80, 93.45, 93.64, 94.47, 94.44, 95.12, 95.49, 96.59, 96.06, 97.38, 96.08, 96.58, 96.57, 96.93]
            elif attack_features == 8:
                main_task_acc = [70.07, 70.08, 70.11, 70.04, 69.91, 69.95, 69.85, 69.59, 69.46, 69.20, 68.69, 68.03, 67.14, 66.18, 64.79, 63.30, 61.47, 59.64, 57.75, 55.56, 53.52, 51.23, 49.20, 47.09, 44.91, 42.74, 40.84, 39.12, 37.47, 36.04, 34.34]
                asr = [77.64, 77.12, 76.68, 76.53, 76.06, 75.60, 76.19, 75.57, 75.71, 72.68, 75.08, 74.79, 73.07, 71.68, 71.56, 70.68, 67.61, 67.52, 71.26, 63.59, 60.96, 63.13, 60.42, 60.85, 61.62, 56.41, 58.40, 60.43, 63.60, 64.34, 63.69]
            else:
                raise ValueError
    else:
        raise ValueError
    
    return main_task_acc, asr

def plot_acc(main_task_acc, asr, dataset="CINIC10L", attack_features=31, update_mode="both",
             save_dir="../", pic_type = "png"):
    # 样式参数设置
    linewidth = 1.8
    labelsize = 18
    bwith = 2
    lwith = 2
    markevery=2
    markersize = 8
    ticksize = 12
    x_ticks_gap=5
    legendsize = 16
    legend_loc = "lower left" # upper right, lower right, lower left

    # 创建图形
    fig, ax = plt.subplots(1, 1)# figsize=(16, 9)
   
    # 设置轴的样式
    for spine in ax.spines.values():
        spine.set_linewidth(bwith)
    ax.grid(which="major", ls="--", lw=lwith, c="gray")

    # 颜色映射
    # marker 类型: o: 圆形, *: 五角星, v: 三角形, s: 正方形
    # google 配色: #f4433c 红色, #ffbc32 黄色, #0aa858 绿色, #2d85f0 蓝色
    colors = ['#0aa858', '#f4433c', '#2d85f0', '#ffbc32']
    markers = ['v', 'o', 's', '*']
    
    epochs = list(range(len(main_task_acc)))
    main_task_acc = [acc/100 for acc in main_task_acc]
    asr = [acc/100 for acc in asr]
    
    # 绘制主任务准确率
    ax.plot(
        epochs,
        main_task_acc,
        label=f'Main Task Acc',
        ls="--",
        linewidth=linewidth,
        c=colors[0],
        marker=markers[0],
        markersize=markersize,
        markevery=markevery,
    )
    # 绘制ASR
    ax.plot(
        epochs,
        asr,
        label=f'ASR',
        ls="-",
        linewidth=linewidth,
        c=colors[1],
        marker=markers[1],
        markersize=markersize,
        markevery=markevery,
    )
    
    # 设置x轴
    x_ticks = list(range(0, len(epochs) + 1, x_ticks_gap))
    ax.set_xticks(x_ticks)
    ax.set_xticklabels([f"{x}" for x in x_ticks], fontsize=ticksize)

    # 设置y轴
    ax.set_ylim(-0.05, 1.05)
    y_ticks = np.arange(0, 1.05, 0.2)
    ax.set_yticks(y_ticks)
    ax.set_yticklabels([f"{y:.1f}" for y in y_ticks], fontsize=ticksize)

    # 设置标签和标题
    ax.set_xlabel("Epochs", fontsize=labelsize)
    ax.set_ylabel("Accuracy", fontsize=labelsize)
    
    # 添加Attack Method和Update Mode信息
    # title = f"Attack Method: TECB; Update Mode: bottom_only; Attack Feaure: {attack_features}"
    title = f"Update Mode: {update_mode}; AC: {attack_features}"
    plt.title(title, fontsize=labelsize-2)
    
    ax.legend(fontsize=legendsize, loc=legend_loc,)

    plt.tight_layout()
    save_fig = os.path.join(save_dir, f"AC_{ac}.{pic_type}")
    print(save_fig)
    plt.savefig(save_fig, bbox_inches='tight')
    plt.close()



if __name__ == "__main__":
    # main_task_acc = [47.4, 46.84, 45.2, 41.74, 36.05, 29.46, 24.17, 20.02, 17.6, 15.42, 13.63]
    # asr =  [98.89, 90.7, 90.65, 56.8, 38.24, 8.73, 0.79, 2.06, 0.45, 0.11, 0.79] 
    # plot_acc(main_task_acc, asr, attack_features=16, save_dir=f"../../results/pretest/permuted_training/", pic_type = "png")
    
    dataset = "CINIC10L"
    updata_mode = "bottom_only"
    acs = [8, 16, 20, 24, 28, 31]
    for ac in acs:
        main_task_acc, asr = get_data(dataset=dataset, attack_features=ac, updata_mode=updata_mode)
        plot_acc(main_task_acc, asr, dataset=dataset, attack_features=ac, save_dir=f"../../results/pretest/permuted_training/test_bottom_only/CINIC10L/", pic_type = "png")
